default:
  image:
    name: node:22
  tags:
    - docker
  cache:
    key: $CI_COMMIT_REF_SLUG
    policy: pull-push
    paths:
      - .yarn/

.before_script: &before_script
  before_script:
    - yarn install --immutable --check-cache

stages:
  - lint
  - typecheck
  - test
  - e2e

lint:
  stage: lint
  <<: *before_script
  timeout: 10m
  script:
    - make install-immutable
    - make lint-check
  only:
    - $CI_PIPELINE_SOURCE != "cancelled"

typecheck:
  stage: typecheck
  <<: *before_script
  timeout: 10m
  script:
    - make typecheck
  only:
    - $CI_PIPELINE_SOURCE != "cancelled"

test:
  image: node:22
  services:
    - postgres:16.3
  variables:
    POSTGRES_DB: bibcnrs
    POSTGRES_USER: postgres
    POSTGRES_PASSWORD: S3cr3t
    DATABASE_URL: postgres://postgres:S3cr3t@db-test/bibcnrs
  script:
    - yarn install
    - yarn workspace @bibcnrs/api run test

e2e:
  stage: e2e
  <<: *before_script
  image: docker:latest
  services:
    - name: docker:dind
      alias: docker
      command: ["--host=tcp://0.0.0.0:2375", "--host=unix:///var/run/docker.sock"]
  variables:
    DOCKER_HOST: tcp://docker:2375/
    DOCKER_TLS_CERTDIR: ""
  timeout: 10m
  script:
    - make install-immutable
    - make test-e2e-install
    - make test-e2e-start
    - make test-e2e-ci
    - make test-e2e-stop
  artifacts:
    name: E2E Test Artifacts
    paths:
      - packages/e2e/playwright-report/
      - packages/e2e/test-results/
    expire_in: 30 days
  only:
    - $CI_PIPELINE_SOURCE != "cancelled"
