default:
  image:
    name: node:lts
  tags:
      - docker
  cache: 
    key: $CI_COMMIT_REF_SLUG
    policy: pull-push
    paths:
        - .yarn/

.before_script: &before_script
  before_script:
    - yarn install --immutable --check-cache

stages:
  - lint
  - typecheck
  - test
  - e2e

lint:
  stage: lint
  <<: *before_script
  timeout: 10m
  script:
    - make install-immutable
    - make lint-check
  only:
    - $CI_PIPELINE_SOURCE != "cancelled"


typecheck:
  stage: typecheck
  <<: *before_script
  timeout: 10m
  script:
    - make typecheck
  only:
    - $CI_PIPELINE_SOURCE != "cancelled"

test: 
  stage: test
  image: docker/compose:latest
  services:
    - name: docker:dind
      alias: docker
  variables:
    DOCKER_HOST: tcp://docker:2375/
    DOCKER_TLS_CERTDIR: ""
  before_script:
    - apt-get update && apt-get install -y curl
    - curl -sS https://dl.yarnpkg.com/debian/pubkey.gpg | apt-key add -
    - echo "deb https://dl.yarnpkg.com/debian/ stable main" | tee /etc/apt/sources.list.d/yarn.list
    - apt-get update && apt-get install -y yarn
  script:
    - yarn install --immutable --check-cache
    - make install-immutable
    - make test-api
  timeout: 10m
e2e:
  stage: e2e
  <<: *before_script
  image: docker:latest
  services:
    - docker:dind
  variables:
    DOCKER_HOST: tcp://docker:2375/
    DOCKER_TLS_CERTDIR: ""
  timeout: 10m
  script:
    - make install-immutable
    - make test-e2e-install
    - make test-e2e-start
    - make test-e2e-ci
    - make test-e2e-stop

  artifacts:
     name: E2E Test Artifacts
     paths:
       - packages/e2e/playwright-report/
       - packages/e2e/test-results/    
     expire_in: 30 days
  only:
    - $CI_PIPELINE_SOURCE != "cancelled"




