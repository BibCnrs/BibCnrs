default:
  image:
    name: node:22
  tags:
    - docker
  cache:
    key: $CI_COMMIT_REF_SLUG
    policy: pull-push
    paths:
      - .yarn/

.before_script: &before_script
  before_script:
    - yarn install --immutable --check-cache

stages:
  - lint
  - typecheck
  - test

lint:
  stage: lint
  <<: *before_script
  timeout: 10m
  script:
    - make lint-check

typecheck:
  stage: typecheck
  <<: *before_script
  timeout: 10m
  script:
    - make typecheck

.test:api:
  stage: test
  image: node:22
  services:
    - postgres:16.3
  variables:
    POSTGRES_DB: bibcnrs
    POSTGRES_USER: postgres
    POSTGRES_PASSWORD: S3cr3t
    DATABASE_URL: postgres://postgres:S3cr3t@postgres:5432/bibcnrs
    NODE_ENV: ${NODE_ENV:-development}
    MAIL_SERVER_HOST: mail
    MAIL_SERVER_PORT: 1025
    cookie_secret: S3cr3t!C00kie
    header_secret: S3cr3t!H34d3r
    admin_secret: S3cr3t!4dm1n
    BIB_CONTENT_DELIVERY_HOST: http://localhost:3000/files
    MAIL_FROM: bibcnrs@bib.cnrs.fr
    MAIL_TO: assistance-portail@inist.fr
    BIB_UPLOADS_DIR: /app/packages/api/uploads
  <<: *before_script
  script:
    - yarn workspace @bibcnrs/api run test

.test:front:
  stage: test
  image: node:22
  services:
    - postgres:16.3
  variables:
    POSTGRES_DB: bibcnrs
    POSTGRES_USER: postgres
    POSTGRES_PASSWORD: S3cr3t
    DATABASE_URL: postgres://postgres:S3cr3t@postgres:5432/bibcnrs
    NODE_ENV: development
    VITE_ENV: development
    VITE_BIBAPI_HOST: http://localhost:3000/api
    VITE_SOURCE_MAP: true
  <<: *before_script
  script:
    - yarn workspace @bibcnrs/front run test

# .test:e2e:
#   stage: test
#   image: node:22
#   services:
#     - postgres:16.3
#     - redis:7.2.5
#   variables:
#     POSTGRES_DB: bibcnrs
#     POSTGRES_USER: postgres
#     POSTGRES_PASSWORD: S3cr3t
#     DATABASE_URL: postgres://postgres:S3cr3t@postgres:5432/bibcnrs
#     NODE_ENV: test
#     RENATER_FAKE_LOGIN: true
#     BIBAPI_HOST: http://localhost:3000/api
#     cookie_secret: ${cookie_secret}
#     header_secret: ${header_secret}
#     admin_secret: ${admin_secret}
#     ticket_secret: ${ticket_secret}
#     BIB_CONTENT_DELIVERY_HOST: http://localhost:3000/files
#     ebsco_host: ${ebsco_host}
#     EZ_UNPAYWALL_URL: ${EZ_UNPAYWALL_URL}
#     EZ_UNPAYWALL_KEY: ${EZ_UNPAYWALL_KEY}
#     METADORE_URL: ${METADORE_URL}
#     METADORE_API_KEY: ${METADORE_API_KEY}
#     DOAJ_URL: ${DOAJ_URL}
#     REDIS_HOST: redis
#     REDIS_PORT: 6379
#     bib_admin_host: http://localhost:3000/admin
#     MAIL_FROM: bibcnrs@bib.cnrs.fr
#     MAIL_TO: assistance-portail@inist.fr
#     BIB_UPLOADS_DIR: /app/packages/api/uploads
#   timeout: 10m
#   <<: *before_script
#   script:
#     - yarn workspace @bibcnrs/e2e run playwright install
#     - yarn workspace @bibcnrs/api run start:e2e -d &
#     - sleep 20
#     - yarn workspace @bibcnrs/e2e run test
#   artifacts:
#     name: E2E Test Artifacts
#     paths:
#       - packages/e2e/playwright-report/
#       - packages/e2e/test-results/
#     expire_in: 30 days
#   only:
#     - $CI_PIPELINE_SOURCE != "cancelled"

