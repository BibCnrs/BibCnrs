default:
  image:
    name: docker:20.10.16
  tags:
    - docker
  services:
    - docker:20.10.16-dind
  variables:
    DOCKER_HOST: tcp://docker:2375/
    DOCKER_TLS_CERTDIR: ""
  before_script:
    - docker info
    - docker-compose version
    - apk add --no-cache make

stages:
  - lint
  - typecheck
  - test
  - e2e

lint:
  stage: lint
  script:
    - make install-immutable
    - make lint-check
  only:
    - $CI_PIPELINE_SOURCE != "cancelled"

typecheck:
  stage: typecheck
  script:
    - make typecheck
  only:
    - $CI_PIPELINE_SOURCE != "cancelled"

test:
  stage: test
  script:
    - make install-immutable
    - make test-api
  timeout: 10m

e2e:
  stage: e2e
  script:
    - make install-immutable
    - make test-e2e-install
    - make test-e2e-start
    - make test-e2e-ci
    - make test-e2e-stop
  timeout: 10m
  artifacts:
    name: E2E Test Artifacts
    paths:
      - packages/e2e/playwright-report/
      - packages/e2e/test-results/
    expire_in: 30 days
  only:
    - $CI_PIPELINE_SOURCE != "cancelled"