default:
  image:
    name: node:22
  tags:
      - docker
  cache: 
    key: $CI_COMMIT_REF_SLUG
    policy: pull-push
    paths:
        - .npm/

.before_script: &before_script
  before_script:
    - npm ci --cache .npm --prefer-offline

stages:
  - lint
  - typecheck
  - test
  - e2e

lint:
  stage: â¬£ Lint
  <<: *before_script
  timeout: 10m
  script:
    - make install-immutable
    - make lint-check

typecheck:
  stage: Ê¦ TypeScript
  <<: *before_script
  timeout: 10m
  script:
    - make type-check

test: 
  stage: ðŸ”Ž Test
  <<: *before_script
  timeout: 10m
  script:
    - make install-immutable
    - make test-api

e2e:
  stage: ðŸŒ³ E2E Test
  <<: *before_script
  timeout: 10m
  script:
    - make install-immutable
    - make test-e2e-install
    - make test-e2e-start
    - make test-e2e-ci
    - make test-e2e-stop

  artifacts:
     name: E2E Test Artifacts
     paths:
       - packages/e2e/playwright-report/
       - packages/e2e/test-results/    
     expire_in: 30 days

  only:
    - $CI_PIPELINE_SOURCE != "cancelled"


